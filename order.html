<!DOCTYPE html>
<html>
<head>
    <title>order</title>
</head>
<body>

<div class="container">
    <div id="mainChart">
        <div class="reset" style="visibility: hidden;">selected: <span class="filter"></span>
            <a href="javascript:mainChart.filterAll();dc.redrawAll();">reset</a>
        </div>
    </div>

    <div id="weekendTotal">
        <div class="reset" style="visibility: hidden;">range: <span class="filter"></span>
            <a href="javascript:weekendTotalChart.filterAll();dc.redrawAll();">reset</a>
        </div>
    </div>

    <div id="chart-row-spenders">
        <div class="reset" style="visibility: hidden;">selected: <span class="filter"></span>
            <a href="javascript:byDayChart.filterAll();dc.redrawAll();">reset</a>
        </div>
    </div>
</div>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.1.0/jquery.min.js"></script>
<script type="text/javascript" src="js/d3.js"></script>
<script type="text/javascript" src="js/crossfilter.js"></script>
<script type="text/javascript" src="js/dc.js"></script>

<script>
    var parseDate = function(mysqlTimestamp){
//    // Split timestamp into [ Y, M, D, h, m, s ]
//    var t = mysqlTimestamp.split(/[- :]/);
//
//    // Apply each element to the Date function
//    return new Date(Date.UTC(t[0], t[1]-1, t[2], t[3], t[4], t[5]));
        var debug = d3.time.format('%Y-%m-%d %H:%M:%S').parse(mysqlTimestamp);
//    var debug = d3.time.format('%Y-%m-%d').parse('2016-07-28');
//    console.log(debug);
        return debug;
    };

    function print_filter(f){
        if(typeof(f.length) != "undefined"){
        }else{
        }
        if(typeof(f.top) != "undefined"){
            f = f.top(Infinity);
        }else{
        }
        if(typeof(f.dimension) != "undefined"){
            f = f.dimension(function(d){
                return "";
            }).top(Infinity);
        }else{
        }
        console.log("(" + f.length + ") = " + JSON.stringify(f).replace("[", "[\n\t").replace(/}\,/g, "},\n\t")
                                                  .replace("]", "\n]"));
    }

    var allInOne = function(json){
//    console.log(json); // this will show the info it in firebug console


        json.forEach(function(row){
            row.created = parseDate(row.created_timestamp);
            let createdAt = row.created;
//        let createdAt = parseDate(row.created_timestamp);

            row.year = createdAt.getFullYear();

            row.month = createdAt.getMonth() + 1;

            row.date = createdAt.getDate();
        });

        let testRow = json[4];

        console.log(testRow);

        var ndx = crossfilter(json);

//    print_filter(json);

        var dateDim = ndx.dimension(function(d){
            return d.created;
        });

        var dateDimInAgust = dateDim.filter(function(d){
//            console.log(d);
            if(d.getMonth() == 8){
                return d;
            }
        });

        var dateTotalSum = dateDimInAgust.group().reduceSum(function(d){
            return Math.abs(d.total);
        });

        print_filter(dateTotalSum);

        var minDate = dateDimInAgust.bottom(1)[0].created;
        var maxDate = dateDimInAgust.top(1)[0].created;

//    var mainChart = dc.barChart('#mainChart');
//    mainChart
//            .dimension(dateDim)
//            .x(d3.time.scale().domain([minDate,maxDate]))
//            .group(dateTotalSum);
//

        var chart = dc.lineChart('#mainChart');
        chart
                .width(4000)
                .height(1600)
                .dimension(dateDimInAgust)
                .group(dateTotalSum)
                .x(d3.time.scale().domain([minDate,maxDate]));

        dc.renderAll();

    };

    $.getJSON("dump-order.json", function(json){

        json.forEach(function(row){
            row.created = parseDate(row.created_timestamp);

            var byDate = parseDate(row.created_timestamp);

            byDate.setHours(0,0,0);

            row.byDate = byDate;
        });

        console.log(json[4]);

        var ndx = crossfilter(json);

        var dateDim = ndx.dimension(function(d){return d.byDate;});

        //group lai theo ngay
        var dateTotalSum = dateDim.group().reduceSum(function(d){
            return d.total;
        });


//        console.log(dateTotalSum.top(10));

        console.log(dateTotalSum.size());

        var mainChart = dc.barChart('#mainChart');

        minDate = dateDim.bottom(1)[0].byDate;
        maxDate = dateDim.top(1)[0].byDate;

        mainChart
                .width(1000).height(400)
                .dimension(dateDim)
                .group(dateTotalSum)
                .x(d3.scale.ordinal())
//                .x(d3.time.scale().domain([minDate, maxDate]))
                .xUnits(dc.units.ordinal)
                .elasticX(true)
                .elasticY(true)
                .brushOn(true);

        var weekendTotalChart = dc.pieChart('#weekendTotal');

        
        
        
        dc.renderAll();



    });

</script>
</body>
</html>