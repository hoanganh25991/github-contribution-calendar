<!DOCTYPE html>
<html>
<head>
    <title>order</title>
    <link rel="stylesheet"
          href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.0.0-alpha/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/dc/1.7.5/dc.css">
    <style>
        /*div {*/
        /*width: 100vw;*/
        /*}*/
    </style>
</head>
<body>

<div>
    <div class="container-fluid">
        <div class="row">
            <div class="col-md-12">
                <div class="row">
                    <h1>sum revenue / date</h1>
                    <div id="mainChart"></div>
                </div>

                <div class="row">
                    <h1>count order / date </h1>
                    <div id="orderChart"></div>
                </div>

                <div class="row">
                    <h1>average total-order / date</h1>
                    <div id="totalOrderChart"></div>
                </div>
                
            </div>

        </div>
    </div>
    <div style="position: fixed; top: 0; right: 0">
        <div class="row">
            <h1>sum revenue / weekend</h1>
            <div id="weekendChart"></div>
        </div>

        <div class="row">
            <h1>count customer / weekend</h1>
            <div id="weekendChart2"></div>
        </div>

        <div class="row">
            <h1>total on range</h1>
            <div id="totalChart"></div>
            <div id="totalOnRangeChart"></div>
            <!--<div id="totalOnRangeChart">-->
                <!--{{ totalOnRange }}-->
            <!--</div>-->
        </div>
    </div>
</div>

<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.1.0/jquery.min.js"></script>
<script type="text/javascript" src="js/d3.js"></script>
<script type="text/javascript" src="js/crossfilter.js"></script>
<script type="text/javascript" src="js/reductio.min.js"></script>
<script type="text/javascript" src="js/dc.js"></script>

<script>
    //timestamp 2016-07-28 13:48:54
    //    var parseDate = function(timestamp){
    //        return d3.time.format('%Y-%m-%d %H:%M:%S').parse(timestamp);
    //    };

    var mainChart = {};
    var dateDim = {};

    var monthNames = ["Jan", "Feb", "Mar", "Apr", "May", "Jun",
        "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];

    var totalOnRange = {};

    $.getJSON("dump-order-4.json", function(json){
        //transform json
        json.forEach(function(row){
            //row.created is timestamp, 1476876234 (second)
            var created = new Date(row.created * 1000);

            row.date = Math.floor(row.created / (24 * 60 * 60));

            //sort by month

            //sort by year

            //sort by weekend
            //getDay 0 1 2 ... 6
            // >>> sun mon tue ... sat
            var dayInWeek = created.getDay();
            //6 - sat, 0 - sun
            row.weekend = 'weekday';

            if(dayInWeek == 6 || dayInWeek == 0){
                row.weekend = 'weekend';
            }

            row.total = Math.floor(Number(row.total));

            row.pax = Number(row.pax);

            row.dummyGroup = 1;
        });

        console.log(json[4]);

        mainChart = dc.barChart('#mainChart');

        var ndx = crossfilter(json);

        dateDim = ndx.dimension(function(d){
            return d.date
        });

        var totalByDate = dateDim.group().reduceSum(function(d){
            return d.total;
        });

        console.log(totalByDate.top(5));

        var minDate = dateDim.bottom(1)[0].date;
        var maxDate = dateDim.top(1)[0].date;

        mainChart
                .width(1000)
                .height(400)
                .dimension(dateDim)
                .group(totalByDate)
                .x(d3.scale.linear().domain([minDate, maxDate]));

        mainChart.xAxis().tickFormat(function(d){
            var timestamp = d * (24 * 60 * 60);
            var date = new Date(timestamp * 1000);
            return date.getFullYear() + '-' + monthNames[date.getMonth()] + '-' + date.getDate();
        }); // convert back to date string 2016-Aug-15


        var weekendChart = dc.pieChart('#weekendChart');

        var weekendDim = ndx.dimension(function(d){
            return d.weekend;
        });

        var totalByWeekend = weekendDim.group().reduceSum(function(d){
            return d.total;
        });

        weekendChart
                .width(200)
                .height(200)
                .dimension(weekendDim)
                .group(totalByWeekend)
                .innerRadius(50);

        var weekendChart2 = dc.pieChart('#weekendChart2');

        var customerByWeekend = weekendDim.group().reduceSum(function(d){
            return d.pax;
        });

        weekendChart2
                .width(200)
                .height(200)
                .dimension(weekendDim)
                .group(customerByWeekend)
                .innerRadius(50);


        var orderChart = dc.rowChart('#orderChart');

        var countByDate = dateDim.group().reduceCount(function(d){
            return d.id;
        });

        orderChart
                .width(1000)
                .height(400)
                .dimension(dateDim)
                .group(countByDate)
                .elasticX(true)
                .controlsUseVisibility(true);
//                .x(d3.scale.linear().domain([minDate, maxDate]));


//        var orderChart = dc.barChart('#orderChart');
//
//        var countByDate = dateDim.group().reduceCount(function(d){
//            return d.id;
//        });
//
//        orderChart
//                .width(1000)
//                .height(400)
//                .dimension(dateDim)
//                .group(countByDate)
//                .x(d3.scale.linear().domain([minDate, maxDate]));
//        orderChart.xAxis().tickFormat(function(d){
//            var timestamp = d * (24 * 60 * 60);
//            var date = new Date(timestamp * 1000);
//            return date.getFullYear() + '-' + monthNames[date.getMonth()] + '-' + date.getDate();
//        }); // convert back to date string 2016-Aug-15


        var totalOrderChart = dc.barChart('#totalOrderChart');

        var totalOrderAverage = dateDim.group();

        var reducer = reductio()
                .count(true)
                .sum(function(d){
                    return d.total;
                })
                .avg(true);
        // <--> the same
//        var reducer = reductio()
//                .avg(function(d){return +d.total;});

        reducer(totalOrderAverage);

        totalOrderChart
                .width(1000)
                .height(400)
                .dimension(dateDim)
                .group(totalOrderAverage)
                .valueAccessor(function(d){
                    return d.value.avg;
                })
                .x(d3.scale.linear().domain([minDate, maxDate]));

        totalOrderChart.xAxis().tickFormat(function(d){
            var timestamp = d * (24 * 60 * 60);
            var date = new Date(timestamp * 1000);
            return date.getFullYear() + '-' + monthNames[date.getMonth()] + '-' + date.getDate();
        }); // convert back to date string 2016-Aug-15


//        var totalChart = dc.rowChart('#totalChart');
//        var total = dateDim.groupAll().reduceSum(function(d){return d.total}).value();
//        var obj = {key: 1, value: total};
//        totalChart
//                .width(200)
//                .height(400)


        var totalOnRangeChart = dc.rowChart('#totalOnRangeChart');

        var dummyGroup = ndx.dimension(function(d){return d.dummyGroup});

        totalOnRange = dummyGroup.group().reduceSum(function(d){return d.total});

        totalOnRangeChart
                .width(400)
                .height(100)
                .dimension(dummyGroup)
                .group(totalOnRange)
                .elasticX(true)
                .controlsUseVisibility(true);

        dc.renderAll();


    });

</script>
</body>
</html>