<!DOCTYPE html>
<html>
<head>
    <title>order</title>
    <link rel="stylesheet"
          href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.0.0-alpha/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/dc/1.7.5/dc.css">
</head>
<body>

<div class="container">
    <div id="mainChart">
        <div class="reset" style="visibility: hidden;">selected: <span class="filter"></span>
            <a href="javascript:dateDim.filterAll();dc.redrawAll();">reset</a>
        </div>
    </div>

    <div id="weekendChart">
        <div class="reset" style="visibility: hidden;">range: <span class="filter"></span>
            <a href="javascript:weekendChart.filterAll();dc.redrawAll();">reset</a>
        </div>
    </div>

    <div id="weekendChart2" style="margin-left: 50px">
        <div class="reset" style="visibility: hidden;">selected: <span class="filter"></span>
            <a href="javascript:weekendChart2.filterAll();dc.redrawAll();">reset</a>
        </div>
    </div>
</div>

<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.1.0/jquery.min.js"></script>
<script type="text/javascript" src="js/d3.js"></script>
<script type="text/javascript" src="js/crossfilter.js"></script>
<script type="text/javascript" src="js/dc.js"></script>

<script>
    var parseDate = function(mysqlTimestamp){
        return d3.time.format('%Y-%m-%d %H:%M:%S').parse(mysqlTimestamp);
    };

    var mainChart = {};
    var dateDim = {};

    var monthNames = ["Jan", "Feb", "Mar", "Apr", "May", "Jun",
        "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];

    $.getJSON("dump-order-4.json", function(json){
        //transform json
        json.forEach(function(d){
            d.total = Math.floor(d.total);
        });

        mainChart = dc.barChart('#mainChart');

        var ndx = crossfilter(json);

        dateDim = ndx.dimension(function(d){
            d.days = Math.floor(d.created / (24 * 60 ^ 60));
            return d.days;
        });

        var totalByDate = dateDim.group().reduceSum(function(d){
            return d.total;
        });

        var minDate = totalByDate.bottom(1)[0].key;
        var maxDate = totalByDate.top(1)[0].key;

        mainChart
                .width(1000)
                .height(400)
                .dimension(dateDim)
                .group(totalByDate)
                .x(d3.scale.linear().domain([minDate, maxDate]));

        mainChart.xAxis().tickFormat(function(d){
            var timestamp = d * (24 * 60 * 60);
            var date = new Date(timestamp * 1000);
            return date.getFullYear() + '-' + monthNames[date.getMonth()] + '-' + date.getDate();
        });

        var weekendChart = dc.pieChart('#weekendChart');

        var weekendDim = ndx.dimension(function(d){
            var date = new Date(d * 1000);

            var dayInWeek = date.getDay();

            d.weekend = 'weekday';

            if(dayInWeek == 0 || dayInWeek == 6){
                d.weekend = 'weekend';
            }

            return d.weekend;
        });

        var totalByWeekend = weekendDim.group().reduceSum(function(d){
            return d.total;
        });

        weekendChart
                .width(200)
                .height(200)
                .dimension(weekendDim)
                .group(totalByWeekend)
                .innerRadius(50);

        var weekendChart2 = dc.pieChart('#weekendChart2');

        var customerByWeekend = weekendDim.group().reduceSum(function(d){
            return d.pax;
        });

        weekendChart2
                .width(200)
                .height(200)
                .dimension(weekendDim)
                .group(customerByWeekend)
                .innerRadius(50);


        dc.renderAll();


    });

</script>
</body>
</html>